# Bluetooth + FOTA Overlay Configuration
# Project: LoRa P2P Encrypted Communication with FOTA
# Board: Seeed XIAO nRF54L15
#
# This overlay adds Bluetooth Low Energy and FOTA capabilities to the application.
# Use this overlay when building firmware that supports over-the-air updates.

# ==============================================================================
# Bluetooth Core Configuration
# ==============================================================================

CONFIG_BT=y
CONFIG_BT_PERIPHERAL=y

# Device name shown during Bluetooth scanning
CONFIG_BT_DEVICE_NAME="LoRa_P2P_FOTA"

# Allow device name to be readable without pairing
CONFIG_BT_DEVICE_NAME_GATT_WRITABLE=n

# ==============================================================================
# Nordic MCUmgr BT OTA DFU Module (Quick Start)
# ==============================================================================

# This single option enables a complete FOTA solution including:
# - SMP (Simple Management Protocol) over Bluetooth
# - Image management handlers
# - OS management handlers (reboot)
# - Settings partition erase
# - Optimized Bluetooth buffers for fast transfer
CONFIG_NCS_SAMPLE_MCUMGR_BT_OTA_DFU=y

# Enable speedup optimizations (larger Bluetooth packets, faster FOTA)
CONFIG_NCS_SAMPLE_MCUMGR_BT_OTA_DFU_SPEEDUP=y

# ==============================================================================
# Security: Require Authentication for SMP Access
# ==============================================================================

# IMPORTANT: Require Bluetooth pairing before allowing FOTA updates
# Without this, anyone can flash firmware to your device over Bluetooth!
CONFIG_MCUMGR_TRANSPORT_BT_PERM_RW_AUTHEN=y

# Enable pairing/bonding support
CONFIG_BT_SMP=y
CONFIG_BT_BONDABLE=y

# NOTE: Security level (1-4) is set at RUNTIME via bt_conn_set_security()
#       There is no Kconfig option for default security level.
#       Your application can call bt_conn_set_security(conn, BT_SECURITY_L3)
#       to require authenticated pairing with encryption.

# ==============================================================================
# Stack Size Adjustments for BT + MCUmgr + LoRa
# ==============================================================================

# Increase main thread stack (Bluetooth + LoRa + Crypto operations)
CONFIG_MAIN_STACK_SIZE=8192

# Increase system workqueue stack (MCUmgr operations + BT events)
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=4096

# Increase idle stack for cleanup operations
CONFIG_IDLE_STACK_SIZE=1024

# ==============================================================================
# Bluetooth Connection Parameters (Optional - Defaults are Good)
# ==============================================================================

# NOTE: These parameters are connection interval preferences.
#       Values are in 1.25ms units (e.g., 6 = 7.5ms, 40 = 50ms)
#       Zephyr defaults: min=24 (30ms), max=40 (50ms), latency=0, timeout=42 (420ms)
#       Faster intervals = faster FOTA but higher power consumption.

# Uncomment for faster connection intervals (7.5ms - 15ms):
# CONFIG_BT_PERIPHERAL_PREF_MIN_INT=6
# CONFIG_BT_PERIPHERAL_PREF_MAX_INT=12
# CONFIG_BT_PERIPHERAL_PREF_LATENCY=0
# CONFIG_BT_PERIPHERAL_PREF_TIMEOUT=40

# ==============================================================================
# Bluetooth Advertising
# ==============================================================================

# NOTE: Advertising is automatically enabled when CONFIG_BT_PERIPHERAL=y
#       Advertising intervals are set at RUNTIME via bt_le_adv_start()
#       There are NO Kconfig options for advertising intervals.

# ==============================================================================
# Memory Optimization
# ==============================================================================

# Optimize heap size for BT + MCUmgr
CONFIG_HEAP_MEM_POOL_SIZE=16384

# Number of Bluetooth connections (1 for FOTA client)
CONFIG_BT_MAX_CONN=1

# ==============================================================================
# Optional: MCUmgr Shell Transport (Commented out by default)
# ==============================================================================

# Uncomment to enable FOTA over shell/UART (for debugging)
# CONFIG_MCUMGR_TRANSPORT_SHELL=y

# ==============================================================================
# Logging Adjustments
# ==============================================================================

# Reduce Bluetooth log spam (keep warnings and errors only)
CONFIG_BT_LOG_LEVEL_WRN=y

# Enable MCUmgr logging for debugging FOTA issues
CONFIG_MCUMGR_LOG_LEVEL_INF=y

# ==============================================================================
# Settings Storage (Already configured in main prj.conf)
# ==============================================================================

# Settings are required for MCUmgr to work properly
# Your project already has CONFIG_SETTINGS=y and CONFIG_ZMS=y
# No additional configuration needed here
