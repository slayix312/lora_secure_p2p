# GPIO Configuration
CONFIG_GPIO=y

# SPI Configuration - Core Support
CONFIG_SPI=y
CONFIG_SPI_NRFX=y
CONFIG_SPI_INIT_PRIORITY=70

# EasyDMA requires RAM buffers (flash-based buffers won't work)
# SPI_NRFX_SPIM and NRFX_SPIM00 are automatically selected based on device tree
CONFIG_SPI_NRFX_RAM_BUFFER_SIZE=256

# LoRa Driver Support - Semtech SX126x family
CONFIG_LORA=y
CONFIG_LORA_SX126X=y

# Logging Configuration
CONFIG_LOG=y
CONFIG_LOG_MODE_IMMEDIATE=y
CONFIG_PRINTK=y
CONFIG_CONSOLE=y

# UART/USB Serial Console Configuration (default for terminal logging)
CONFIG_LOG_BACKEND_UART=y
CONFIG_UART_CONSOLE=y

# Disable RTT by default so logs are visible in a serial terminal.
# Re-enable these for J-Link RTT debugging if needed.
CONFIG_USE_SEGGER_RTT=n
CONFIG_RTT_CONSOLE=n
CONFIG_LOG_BACKEND_RTT=n

# Production logging levels (INFO for important events, WARNING for errors)
# For verbose debug logging, build with: west build ... -- -DEXTRA_CONF_FILE=debug.conf
CONFIG_SPI_LOG_LEVEL_INF=y
CONFIG_LORA_LOG_LEVEL_INF=y
CONFIG_GPIO_LOG_LEVEL_WRN=y

# Enhanced debugging configuration
# Note: LOG_BUFFER_SIZE only applies to LOG_MODE_DEFERRED, not LOG_MODE_IMMEDIATE
# Note: DIO1 interrupt mode is automatically enabled by driver when dio1-gpios is present in devicetree

# Shell is debug-only; enabled in debug.conf to reduce production attack surface.

# Kernel Configuration - Increased for LoRa driver interrupt handling
CONFIG_HEAP_MEM_POOL_SIZE=4096
# Main stack size: 8192 bytes required for PSA Crypto ECDH + HKDF operations
# Based on Nordic nRF Connect SDK v2.8.0+ recommendations for nRF54L15
# CRACEN hardware acceleration requires significant stack during key derivation
CONFIG_MAIN_STACK_SIZE=8192

# System workqueue stack size - CRITICAL for LoRa DIO1 interrupt processing
# Default is too small, causes stack overflow when handling SX1262 interrupts
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=2048

# Random Number Generator - Required for jitter functionality
# nRF54L15 uses CRACEN-based RNG, configured automatically via devicetree
# The PSA crypto RNG driver (CONFIG_ENTROPY_PSA_CRYPTO_RNG) is auto-enabled
CONFIG_ENTROPY_GENERATOR=y

# ============================================================================
# PSA Crypto API & Hardware Acceleration (Phase 1: AES-CCM Foundation)
# ============================================================================

# Nordic Security Backend - Provides PSA Crypto API implementation
CONFIG_NRF_SECURITY=y
CONFIG_MBEDTLS_PSA_CRYPTO_C=y

# Heap Configuration for mbedTLS (required for PSA operations)
CONFIG_MBEDTLS_ENABLE_HEAP=y
CONFIG_MBEDTLS_HEAP_SIZE=16384

# CRACEN Hardware Crypto Accelerator (nRF54L15 only)
# Provides ~10-15x performance improvement vs software crypto
CONFIG_PSA_CRYPTO_DRIVER_CRACEN=y
CONFIG_PSA_CRYPTO_DRIVER_OBERON=n  # Disable software fallback for debugging

# AES Algorithm Support (Authenticated Encryption with Associated Data)
CONFIG_PSA_WANT_KEY_TYPE_AES=y
CONFIG_PSA_WANT_ALG_CCM=y           # AES-CCM mode (encryption + authentication)
CONFIG_PSA_WANT_AES_KEY_SIZE_128=y  # 128-bit keys

# Random Number Generation for Cryptographic Operations
CONFIG_PSA_WANT_GENERATE_RANDOM=y

# ============================================================================
# Phase 2: Elliptic Curve Cryptography (ECC) for ECDH Key Exchange
# ============================================================================

# ECC Key Types and Algorithms
CONFIG_PSA_WANT_KEY_TYPE_ECC_KEY_PAIR_GENERATE=y
CONFIG_PSA_WANT_KEY_TYPE_ECC_KEY_PAIR_IMPORT=y
CONFIG_PSA_WANT_KEY_TYPE_ECC_KEY_PAIR_EXPORT=y
CONFIG_PSA_WANT_KEY_TYPE_ECC_PUBLIC_KEY=y
CONFIG_PSA_WANT_ALG_ECDH=y

# Curve25519 (Montgomery curve for X25519 ECDH)
CONFIG_PSA_WANT_ECC_MONTGOMERY_255=y

# Key Derivation Function (for deriving session keys from shared secret)
CONFIG_PSA_WANT_ALG_HMAC=y      # Required by HKDF
CONFIG_PSA_WANT_ALG_HKDF=y
CONFIG_PSA_WANT_ALG_SHA_256=y   # Required by HKDF

# ============================================================================
# Phase 3: KMU (Key Management Unit) and Persistent Key Storage
# ============================================================================

# Persistent Key Storage
CONFIG_MBEDTLS_PSA_CRYPTO_STORAGE_C=y

# Trusted Storage (Internal Trusted Storage)
CONFIG_TRUSTED_STORAGE=y
CONFIG_PSA_INTERNAL_TRUSTED_STORAGE=y

# Hardware Unique Key (HUK) for key encryption
CONFIG_HW_UNIQUE_KEY=y
CONFIG_HW_UNIQUE_KEY_RANDOM=y

# Settings Subsystem (for persistent data)
CONFIG_SETTINGS=y
CONFIG_ZMS=y           # Enable ZMS subsystem (required by SETTINGS_ZMS)
CONFIG_SETTINGS_ZMS=y  # Zephyr Memory Storage (for nRF54L15)

# Flash Support (required for persistent storage)
CONFIG_FLASH=y
CONFIG_FLASH_MAP=y

# KMU Configuration (Key Management Unit hardware)
CONFIG_CRACEN_LIB_KMU=y
CONFIG_CRACEN_PROVISION_PROT_RAM_INV_DATA=y
CONFIG_CRACEN_IKG=y
CONFIG_CRACEN_IKG_SEED_LOAD=y

# Note: Persistent keys will be stored with HUK encryption for security

# ============================================================================
# MCUboot Bootloader Support (for FOTA Updates)
# ============================================================================

# MCUboot compatibility marker - signals that this app is designed to run with MCUboot
# ⚠️ IMPORTANT: Comment this out when building without MCUboot (--no-sysbuild)
# CONFIG_BOOTLOADER_MCUBOOT=y

# Note: Two build modes are supported:
#
# 1. WITH MCUboot + FOTA (requires J-Link for KMU provisioning):
#    - Uncomment CONFIG_BOOTLOADER_MCUBOOT=y above
#    - Build command: west build ... -DEXTRA_CONF_FILE="overlay-bt-dfu.conf"
#    - See FOTA_SETUP.md for KMU provisioning instructions
#
# 2. WITHOUT MCUboot (no FOTA, works with CMSIS-DAP):
#    - Keep CONFIG_BOOTLOADER_MCUBOOT=y commented out (as shown above)
#    - Build command: west build --no-sysbuild ... -DEXTRA_CONF_FILE="overlay-bt-no-fota.conf"
#    - See Build_&_Flash.md for build/flash instructions
