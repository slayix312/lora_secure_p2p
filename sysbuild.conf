# Sysbuild Configuration for FOTA with MCUboot
# Project: LoRa P2P Encrypted Communication with FOTA
# Board: Seeed XIAO nRF54L15

# ==============================================================================
# MCUboot Bootloader Configuration
# ==============================================================================

# Enable MCUboot as the bootloader
SB_CONFIG_BOOTLOADER_MCUBOOT=y

# ==============================================================================
# nRF54L15-Specific Settings
# ==============================================================================

# CRITICAL: nRF54L15 requires larger MCUboot pad (0x800 instead of default 0x200)
# This is due to the RRAM sector size and alignment requirements
SB_CONFIG_PM_MCUBOOT_PAD=0x800

# ==============================================================================
# Signature Verification with Hardware KMU
# ==============================================================================

# Use ED25519 signature algorithm (ECC, smaller signatures than RSA)
SB_CONFIG_BOOT_SIGNATURE_TYPE_ED25519=y

# Use pure signature format (not ECDSA)
SB_CONFIG_BOOT_SIGNATURE_TYPE_PURE=y

# Enable KMU (Key Management Unit) for hardware-based signature verification
# The public key will be stored in the hardware KMU for secure boot
SB_CONFIG_MCUBOOT_SIGNATURE_USING_KMU=y

# ==============================================================================
# Image Signing Configuration
# ==============================================================================

# Path to signing key (relative to this project directory)
# Generate your own key:  imgtool keygen -k mcuboot_signing_key.pem -t ed25519
SB_CONFIG_BOOT_SIGNATURE_KEY_FILE="mcuboot_signing_key.pem"

# ==============================================================================
# Automatic KMU Keyfile Generation
# ==============================================================================

# ⚠️ IMPORTANT: This generates keyfile.json but does NOT auto-provision KMU!
#
# What this config does:
#   ✅ Auto-generates build_ping/keyfile.json from mcuboot_signing_key.pem
#   ❌ Does NOT automatically provision KMU (requires separate step)
#
# Why: The `--recover` flag only works with nrfjprog runner (J-Link hardware).
# The Seeed XIAO nRF54L15 uses CMSIS-DAP, not J-Link.
#
# KMU Provisioning Options:
#   1. Test nrfutil with CMSIS-DAP (experimental - see FOTA_SETUP.md)
#   2. Use J-Link probe for provisioning (Nordic-tested method)
#   3. Use Tigard debugger (requires OpenOCD, limited UICR support)

# Enable automatic KMU keyfile generation during build
SB_CONFIG_MCUBOOT_GENERATE_DEFAULT_KMU_KEYFILE=y

# ==============================================================================
# MCUboot Partition Size
# ==============================================================================

# Note: MCUboot partition size (64KB at 0x0) is defined in device tree
# (xiao_nrf54l15_nrf54l15_cpuapp.dts), no additional configuration needed here

# ==============================================================================
# Optional: Advanced Features (Commented out by default)
# ==============================================================================

# Uncomment to enable key revocation (prevents using compromised keys)
# SB_CONFIG_BOOT_KMU_KEYS_REVOCATION=y

# Uncomment to use external flash for secondary image slot
# SB_CONFIG_PM_EXTERNAL_FLASH_MCUBOOT_SECONDARY=y

# Uncomment for MCUboot direct-xip mode (no swap, faster boot)
# Note: Cannot use with image encryption
# SB_CONFIG_MCUBOOT_MODE_DIRECT_XIP=y

# Uncomment for hardware downgrade prevention (monotonic counter)
# SB_CONFIG_MCUBOOT_HW_DOWNGRADE_PREVENTION=y
# SB_CONFIG_MCUBOOT_HW_DOWNGRADE_PREVENTION_COUNTER_SLOTS=2
# SB_CONFIG_MCUBOOT_HW_DOWNGRADE_PREVENTION_COUNTER_VALUE=1
